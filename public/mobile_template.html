<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Virtual Production na Semana ABC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00ff9d',
                        secondary: '#0066ff',
                        purpleish: '#9370DB',
                        dark: '#0a0a0a',
                        darker: '#020202',
                        'light-text': '#e0e0e0',
                        'medium-text': '#a0a0a0',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'subtle-float': 'subtle-float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        'subtle-float': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-8px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Fira+Code:wght@400&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020202; color: #e0e0e0; margin: 0; padding: 0; overflow-x: hidden; scroll-behavior: smooth; }
        .gradient-text { background: linear-gradient(90deg, #00ff9d, #0066ff); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .glow-text-primary { text-shadow: 0 0 12px rgba(0, 255, 157, 0.6); }
        .btn-primary-custom { background: linear-gradient(90deg, #00ff9d, #0066ff); color: #050505; transition: all 0.3s ease; padding: 0.625rem 1.25rem; border-radius: 0.3125rem; font-weight: bold; text-align: center; display: inline-block; text-decoration: none; }
        .btn-primary-custom:hover { opacity: 0.9; box-shadow: 0 5px 15px rgba(0, 255, 157, 0.3); transform: translateY(-2px); }
        .btn-share-base { display: inline-flex; justify-content: center; align-items: center; width: 40px; height: 40px; color: white; text-decoration: none; border-radius: 50%; font-weight: bold; transition: all 0.3s ease; }
        .whatsapp-btn { background-color: #25D366; }
        .whatsapp-btn:hover { background-color: #1DA851; }
        .facebook-btn { background-color: #1877F2; }
        .facebook-btn:hover { background-color: #1158B4; }
        .instagram-btn { background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D, #F56040, #F77737, #FCAF45, #FFDC80); }
        .instagram-btn:hover { opacity: 0.9; }
        .twitter-btn { background-color: #000000; border: 1px solid #ffffff; }
        .twitter-btn i { color: #ffffff; }
        .twitter-btn:hover { background-color: #333333; }
        .linkedin-btn { background-color: #0A66C2; }
        .linkedin-btn:hover { background-color: #004182; }
        .download-btn { background-color: #6c757d; }
        .download-btn:hover { background-color: #5a6268; }
    </style>
</head>
<body class="bg-darker text-light-text font-sans">
    <div class="min-h-screen flex flex-col items-center p-4">

        <video id="userVideo" class="w-full max-w-2xl mt-2.5 rounded-lg shadow-lg" controls autoplay playsinline loop muted>
            Seu navegador não suporta a tag de vídeo.
        </video>

        <div class="share mt-5 flex flex-wrap justify-center gap-3">
            <a id="whatsappShare" class="btn-share-base whatsapp-btn" href="#" title="Compartilhar no WhatsApp"><i class="fab fa-whatsapp"></i></a>
            <a id="shareVideo" class="btn-share-base" style="background-color: #ffb300;" href="#" title="Compartilhar"><i class="fas fa-share-alt"></i></a>
            <a id="downloadVideo" class="btn-share-base download-btn" href="#" title="Baixar Vídeo"><i class="fas fa-download"></i></a>
        </div>

        <!-- Modal for sharing instructions -->
        <div id="shareModal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); align-items:center; justify-content:center;">
            <div style="background:#222; color:#fff; padding:2em 1.5em; border-radius:18px; max-width:95vw; width:350px; text-align:center; position:relative;">
                <button id="closeShareModal" style="position:absolute; top:10px; right:15px; background:transparent; color:#fff; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
                <h2 style="font-size:1.3em; margin-bottom:1em;">Como compartilhar o vídeo</h2>
                <div id="shareInstructions"></div>
            </div>
        </div>

        <div class="mt-8 w-full max-w-2xl text-center">
            <h1 class="text-3xl md:text-4xl font-bold gradient-text glow-text-primary mb-8">
                Revolucione suas produções
            </h1>
            <div class="space-y-6">
                <div class="bg-dark p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-primary mb-3">Estúdio e Tecnologia</h2>
                    <p class="text-medium-text mb-4">LED/Disguise/Projeção/Unreal</p>
                    <a href="https://onav.com.br" target="_blank" rel="noopener noreferrer" class="btn-primary-custom">On + Av</a>
                </div>
                <div class="bg-dark p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-primary mb-3">Media Servers</h2>
                    <a href="https://disguise.one" target="_blank" rel="noopener noreferrer" class="btn-primary-custom">Disguise</a>
                </div>
                <div class="bg-dark p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-primary mb-3">Cinebot Draco</h2>
                    <a href="https://rubelabs.com" target="_blank" rel="noopener noreferrer" class="btn-primary-custom">RubeLabs</a>
                </div>
            </div>
        </div>
        <p id="downloadStatus" style="display: none; color: white;"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ---------- 1. Same slug resolution as before ------------------------ */
      const queryParams      = new URLSearchParams(location.search);
      let   videoSlug        = queryParams.get('video');

      if (!videoSlug) {
        const pathName = window.location.pathname;
        const pathSegments = pathName.split('/'); // e.g., ["", "mobile", "some%20slug.html"]
        if (pathSegments.length > 1) { // Ensure there's something after /mobile/
            let lastSegment = pathSegments[pathSegments.length - 1];
            if (lastSegment.endsWith('.html')) {
                lastSegment = lastSegment.slice(0, -'.html'.length); // "some%20slug"
            }
            if (lastSegment) {
                try {
                    videoSlug = decodeURIComponent(lastSegment);
                } catch (e) {
                    console.error('Error decoding video slug from path:', lastSegment, e);
                }
            }
        }
      }

      if (!videoSlug) {
        document.body.innerHTML =
          '<p style="color:white;text-align:center;padding-top:50px">Erro: vídeo não especificado.</p>';
        return;
      }

      /* ---------- 2. Prepare URLs & elements -------------------------------- */
      const encodedVideoSlug = encodeURIComponent(videoSlug); // For Supabase URL
      const videoUrl         = `https://cgcpaactxmygmdxmqyhz.supabase.co/storage/v1/object/public/videos/public/${encodedVideoSlug}.mp4`;
      const shareablePageUrl = `https://abc.onav.com.br/mobile_template.html?video=${encodeURIComponent(videoSlug)}`;
      const logApiBase       = `https://abc.onav.com.br/api/log-share?video=${videoSlug}&platform=`;

      const videoEl          = document.getElementById('userVideo');
      videoEl.src            = videoUrl;
      videoEl.load();
      videoEl.play().catch(()=>{});
      
      fetch(`https://abc.onav.com.br/api/log-scan?video=${videoSlug}`).catch(e => console.warn('Error logging scan:', e));

      /* ---------- 3. Share buttons ----------------------------------------- */
      const shareBtn         = document.getElementById('shareVideo');   // yellow share-alt
      const waBtn            = document.getElementById('whatsappShare');
      const dlBtn            = document.getElementById('downloadVideo');

      /* --- 3a. WhatsApp (any platform) --- */
      waBtn.onclick = () => {
        fetch(logApiBase+'whatsapp').catch(()=>{});
        window.open(
          `whatsapp://send?text=Confira%20meu%20vídeo%20em%20Produção%20Virtual%20da%20On%2BAv%2BRube%20na%20Semana%20ABC:%20${encodeURIComponent(shareablePageUrl)}`,
          '_blank'
        );
        return false;
      };

      /* --- 3b. UNIVERSAL SHARE (tries “file share” on iOS, then falls back) --- */
      shareBtn.onclick = async () => {
        /* ---------- iOS 16.4+ file-sharing path ---------- */
        const iOS      = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const canShareFile = navigator.canShare && navigator.canShare({ files: [] });

        if (iOS && canShareFile) {
          try {
            shareBtn.classList.add('opacity-60','pointer-events-none');
            shareBtn.querySelector('i').classList.add('animate-spin');
            
            /* fetch video, turn into File, invoke share sheet */
            const blob = await fetch(videoUrl, { mode: 'cors' }).then(r => r.blob());
            const file = new File([blob], `${videoSlug}.mp4`, { type: 'video/mp4' });

            await navigator.share({
              title : 'Meu vídeo',
              text  : 'Confira meu vídeo em Produção Virtual da On+Av+Rube na Semana ABC',
              files : [file]                 // <-- magic: opens native share sheet with the file ready
            });

            fetch(logApiBase+'ios_fileshare').catch(()=>{});
          } catch(e) {
            console.warn('iOS file share falhou, caindo para instruções…', e);
            showInstructionModal();
          } finally {
            shareBtn.classList.remove('opacity-60','pointer-events-none');
            shareBtn.querySelector('i').classList.remove('animate-spin');
          }
          return false;
        }

        /* ---------- Modern browsers with Web-Share (but no file support) ---------- */
        if (navigator.share) {
          fetch(logApiBase+'webshare').catch(()=>{});
          navigator.share({
            title: 'Meu vídeo',
            text : 'Confira meu vídeo em Produção Virtual da On+Av+Rube na Semana ABC',
            url  : shareablePageUrl
          }).catch(()=>{});
          return false;
        }

        /* ---------- Fallback: custom instructions modal ---------- */
        showInstructionModal();
        return false;
      };

      /* --- 3c. Download button (Android / desktop keeps your progress logic) --- */
      const downloadStatusEl = document.getElementById('downloadStatus');

      dlBtn.onclick = async () => {
          fetch(logApiBase + 'download').catch(e => console.warn('Error logging download:', e));
          
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

          if (isIOS) {
              downloadStatusEl.textContent = 'Abrindo vídeo...';
              downloadStatusEl.style.display = 'block';
              
              // Open the video in a new tab. iOS will handle it, allowing tap-and-hold to save to Photos.
              window.open(videoUrl, '_blank');
              
              downloadStatusEl.textContent = 'Vídeo aberto! No iPhone, toque e segure no vídeo na nova aba e escolha "Salvar Vídeo".';
              
              setTimeout(() => {
                  downloadStatusEl.style.display = 'none';
              }, 7000); 

          } else {
              // For Android/Desktop, use the advanced download with progress
              downloadStatusEl.textContent = 'Preparando download...';
              downloadStatusEl.style.display = 'block';

              try {
                  const response = await fetch(videoUrl);
                  if (!response.ok) {
                      throw new Error(`Falha ao buscar vídeo: ${response.status} ${response.statusText}`);
                  }
                  
                  const contentLength = response.headers.get('content-length');
                  let loaded = 0;
                  
                  const newResponse = new Response(new ReadableStream({
                      async start(controller) {
                          const reader = response.body.getReader();
                          downloadStatusEl.textContent = 'Baixando vídeo... 0%';
                          while (true) {
                              const { done, value } = await reader.read();
                              if (done) break;
                              loaded += value.byteLength;
                              if (contentLength) {
                                  const percent = Math.round((loaded / contentLength) * 100);
                                  downloadStatusEl.textContent = `Baixando vídeo... ${percent}%`;
                              } else {
                                  downloadStatusEl.textContent = `Baixando vídeo... (${(loaded / (1024*1024)).toFixed(1)} MB)`;
                              }
                              controller.enqueue(value);
                          }
                          controller.close();
                      }
                  }));

                  const videoBlob = await newResponse.blob();
                  const objectUrl = URL.createObjectURL(videoBlob);

                  const a = document.createElement('a');
                  a.style.display = 'none';
                  a.href = objectUrl;
                  
                  let fileName = videoSlug.replace(/[^a-zA-Z0-9_.-]+/g, '_');
                  if (!fileName.toLowerCase().endsWith('.mp4')) {
                       fileName += '.mp4';
                  }
                  a.download = fileName; 
                  
                  document.body.appendChild(a);
                  a.click();
                  
                  downloadStatusEl.textContent = 'Download iniciado!';
                  setTimeout(() => {
                      downloadStatusEl.style.display = 'none';
                  }, 3000);

                  setTimeout(() => {
                      URL.revokeObjectURL(objectUrl);
                      document.body.removeChild(a);
                  }, 100);

              } catch (error) {
                  console.error('Erro ao baixar o vídeo:', error);
                  downloadStatusEl.textContent = 'Erro no download.';
                  setTimeout(() => {
                       downloadStatusEl.style.display = 'none';
                  }, 3000);
                  alert('Houve um erro ao tentar baixar o vídeo. Por favor, tente novamente ou verifique sua conexão.');
              }
          }
          return false; 
      };

      /* ---------- 4. Helper: instruction modal (same as before) ------------------ */
      function showInstructionModal () {
        const modal         = document.getElementById('shareModal');
        const instructions  = document.getElementById('shareInstructions');
        let html = '';

        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          html += '<div style="margin-bottom:1em"><i class="fas fa-mobile-alt" style="font-size:2em;color:#25D366"></i></div>';
          html += '<b>iPhone:</b><br>1.&nbsp;Clique em&nbsp;<b>Baixar Vídeo</b>.<br>2.&nbsp;Toque e segure o vídeo na nova aba e escolha&nbsp;<b>Salvar Vídeo</b>.<br>3.&nbsp;Abra Fotos ➜ Compartilhar ➜ escolha o app que quiser (Instagram, TikTok, etc.).';
        } else if (/Android/i.test(navigator.userAgent)) {
          html += '<div style="margin-bottom:1em"><i class="fab fa-android" style="font-size:2em;color:#3ddc84"></i></div>';
          html += '<b>Android:</b><br>1.&nbsp;Clique em&nbsp;<b>Baixar Vídeo</b>.<br>2.&nbsp;O vídeo será salvo na galeria.<br>3.&nbsp;Compartilhe direto da galeria.';
        } else {
          html += '<div style="margin-bottom:1em"><i class="fas fa-desktop" style="font-size:2em;color:#00ff9d"></i></div>';
          html += '<b>Computador:</b><br>1.&nbsp;Clique em&nbsp;<b>Baixar Vídeo</b>.<br>2.&nbsp;Abra a pasta de downloads e compartilhe com WhatsApp Web ou redes sociais.';
        }
        instructions.innerHTML = html;
        modal.style.display = 'flex';
      }
      document.getElementById('closeShareModal').onclick = () => {
        document.getElementById('shareModal').style.display = 'none';
      };
      document.getElementById('shareModal').onclick = e => {
        if (e.target.id === 'shareModal') e.currentTarget.style.display = 'none';
      };
    });
    </script>
</body>
</html>
